<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('Meu Perfil - Task Management')}"></head>
<body class="dashboard-body">

    <!-- Sidebar -->
    <nav th:replace="~{fragments/sidebar :: sidebar}"></nav>

<div class="main-content" id="mainContent">
    <div class="top-bar">
        <h1 class="page-title">Meu Perfil</h1>
        <div class="user-info">
            <a class="btn btn-primary" th:href="@{/profile/edit}"><i class="bi bi-pencil"></i> Editar Perfil</a>
        </div>
    </div>

    <div class="content-wrapper profile-view-wrapper">
        <div th:replace="~{fragments/alerts :: alerts}"></div>
        
        <!-- Profile Header Card -->
        <div class="form-card profile-section-card" data-animate="fade-up"
             th:with="avatarPath=${#strings.isEmpty(user.profile.avatarUrl) ? '/images/avatar-placeholder.svg' : user.profile.avatarUrl}">
            <div class="profile-header-card">
                <div>
                    <img alt="Avatar" class="profile-avatar"
                         th:src="@{${avatarPath}}"/>
                </div>
                <div class="profile-info">
                    <div style="display:flex; align-items:center; gap:1rem; margin-bottom:0.5rem; flex-wrap:wrap;">
                        <h2 class="profile-name" th:text="${user.fullName != null ? user.fullName : user.username}">Nome</h2>
                        <span th:if="${user.profile.githubName}" class="profile-github-name"
                              th:text="'@' + ${user.profile.githubLogin}"></span>
                    </div>
                    <p class="profile-profession" th:text="${user.profile.profession}">Profiss√£o</p>
                    
                    <!-- GitHub Stats -->
                    <div th:if="${user.profile.githubLogin}" class="github-stats">
                        <div class="github-stat">
                            <div class="github-stat-value" 
                                 th:text="${user.profile.publicRepos != null ? user.profile.publicRepos : 0}">0</div>
                            <div class="github-stat-label">Reposit√≥rios</div>
                        </div>
                        <div class="github-stat">
                            <div class="github-stat-value" 
                                 th:text="${user.profile.followers != null ? user.profile.followers : 0}">0</div>
                            <div class="github-stat-label">Seguidores</div>
                        </div>
                        <div class="github-stat">
                            <div class="github-stat-value" 
                                 th:text="${user.profile.following != null ? user.profile.following : 0}">0</div>
                            <div class="github-stat-label">Seguindo</div>
                        </div>
                        <div th:if="${user.profile.publicGists != null && user.profile.publicGists > 0}" class="github-stat">
                            <div class="github-stat-value" th:text="${user.profile.publicGists}">0</div>
                            <div class="github-stat-label">Gists</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bio and Details Grid -->
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap:1.5rem; margin-top:1.5rem;">
            <!-- Left Column - About -->
            <div class="form-card profile-section-card" data-animate="fade-up">
                <h3 class="profile-section-title">
                    <i class="bi bi-person-badge"></i> Sobre
                </h3>
                <p th:if="${user.profile.bio}" class="profile-bio" th:text="${user.profile.bio}">Bio</p>
                
                <div class="profile-about-section">
                    <div th:if="${user.profile.location}" class="profile-detail-row">
                        <i class="bi bi-geo-alt"></i>
                        <strong>Local:</strong> <span th:text="${user.profile.location}"></span>
                    </div>
                    <div th:if="${user.profile.githubCompany}" class="profile-detail-row">
                        <i class="bi bi-building"></i>
                        <strong>Empresa:</strong> <span th:text="${user.profile.githubCompany}"></span>
                    </div>
                    <div th:if="${user.profile.experienceLevel}" class="profile-detail-row">
                        <i class="bi bi-bar-chart"></i>
                        <strong>N√≠vel:</strong> <span th:text="${user.profile.experienceLevel}"></span>
                    </div>
                    <div th:if="${user.profile.primaryStack}" class="profile-detail-row">
                        <i class="bi bi-stack"></i>
                        <strong>Stack Principal:</strong> <span th:text="${user.profile.primaryStack}"></span>
                    </div>
                    <div th:if="${user.profile.availability}" class="profile-detail-row">
                        <i class="bi bi-clock"></i>
                        <strong>Disponibilidade:</strong> <span th:text="${user.profile.availability}"></span>
                    </div>
                    <div th:if="${user.profile.hireable != null && user.profile.hireable}" style="margin-top:0.5rem;">
                        <span class="hireable-badge">
                            <i class="bi bi-briefcase-fill"></i> Dispon√≠vel para contrata√ß√£o
                        </span>
                    </div>
                </div>
            </div>

            <!-- Right Column - Links -->
            <div class="form-card profile-section-card" data-animate="fade-up">
                <h3 class="profile-section-title">
                    <i class="bi bi-link-45deg"></i> Links
                </h3>
                <div style="display:flex; flex-direction:column; gap:0.85rem;">
                    <a th:if="${user.profile.websiteUrl}" th:href="${user.profile.websiteUrl}" 
                       target="_blank" class="link-item">
                        <i class="bi bi-globe"></i> Website
                    </a>
                    <a th:if="${user.profile.githubUrl}" th:href="${user.profile.githubUrl}" 
                       target="_blank" class="link-item">
                        <i class="bi bi-github"></i> GitHub
                    </a>
                    <a th:if="${user.profile.linkedinUrl}" th:href="${user.profile.linkedinUrl}" 
                       target="_blank" class="link-item">
                        <i class="bi bi-linkedin"></i> LinkedIn
                    </a>
                    <a th:if="${user.profile.twitterUsername}" 
                       th:href="'https://twitter.com/' + ${user.profile.twitterUsername}" 
                       target="_blank" class="link-item">
                        <i class="bi bi-twitter-x"></i> Twitter/X
                    </a>
                </div>
            </div>
        </div>

        <!-- Skills Section -->
        <div th:if="${(skills != null && !skills.isEmpty()) or (softSkills != null && !softSkills.isEmpty())}" 
             class="form-card profile-section-card" data-animate="fade-up" style="margin-top:1.5rem;">
            <div class="skills-grid">
                <div th:if="${skills != null && !skills.isEmpty()}">
                    <h3 class="profile-section-title">
                        <i class="bi bi-lightning-charge-fill"></i> Hard Skills
                    </h3>
                    <div style="display:flex; gap:0.75rem; flex-wrap:wrap;">
                        <span class="skill-chip" th:each="s : ${skills}" th:text="${s}"></span>
                    </div>
                </div>
                <div th:if="${softSkills != null && !softSkills.isEmpty()}">
                    <h3 class="profile-section-title" style="margin-top:0;">
                        <i class="bi bi-people" style="color:var(--accent-color);"></i> Soft Skills
                    </h3>
                    <div style="display:flex; gap:0.75rem; flex-wrap:wrap;">
                        <span class="skill-chip soft" th:each="s : ${softSkills}" th:text="${s}"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gamification Section -->
        <div class="form-card profile-section-card" data-animate="fade-up" style="margin-top:1.5rem;">
            <h3 class="profile-section-title">
                <i class="bi bi-trophy-fill"></i> Gamifica√ß√£o
            </h3>
            <div class="row">
                <div class="col-md-4 text-center">
                    <h3 class="text-primary display-6" th:text="${userScore?.totalPoints ?: 0}">0</h3>
                    <p class="text-muted">Pontos Totais</p>
                </div>
                <div class="col-md-4 text-center">
                    <h3 class="text-success display-6" th:text="${userScore?.totalTasksCompletedInSquads ?: 0}">0</h3>
                    <p class="text-muted">Tasks de Squad</p>
                </div>
                <div class="col-md-4 text-center">
                    <h3 class="text-warning display-6" th:text="${userScore?.totalTasksCompletedEarly ?: 0}">0</h3>
                    <p class="text-muted">Tasks Antecipadas</p>
                </div>
            </div>
            
            <!-- Monthly Badge Section -->
            <hr class="my-4">
            <div class="row align-items-center mb-4">
                <div class="col-md-6">
                    <h5 class="mb-3"><i class="bi bi-award-fill"></i> Selo Mensal</h5>
                    <div class="d-flex align-items-center gap-3" th:if="${currentMonthlyBadge != null}">
                        <div class="monthly-badge monthly-badge-lg" 
                             th:classappend="'badge-' + ${currentMonthlyBadge.level.name().toLowerCase()}">
                            <span class="badge-icon" th:text="${currentMonthlyBadge.level.icon}">üèÜ</span>
                            <span th:text="${currentMonthlyBadge.level.displayName}">N√≠vel</span>
                        </div>
                        <div>
                            <div class="fw-bold" th:text="${currentMonthlyBadge.tasksCompletedInSquads} + ' tasks completadas'">0 tasks</div>
                            <small class="text-muted" th:text="${currentMonthlyBadge.referenceMonth}">M√™s</small>
                        </div>
                    </div>
                    <p th:if="${currentMonthlyBadge == null}" class="text-muted">
                        Complete tasks em squads para ganhar seu primeiro selo!
                    </p>
                </div>
                <div class="col-md-6" th:if="${monthlyBadgeStats != null}">
                    <div class="row text-center">
                        <div class="col-4">
                            <span class="display-6 text-info" th:text="${monthlyBadgeStats.diamondCount()}">0</span>
                            <br><small class="text-muted">üíé Diamante</small>
                        </div>
                        <div class="col-4">
                            <span class="display-6 text-secondary" th:text="${monthlyBadgeStats.totalTasksCompleted()}">0</span>
                            <br><small class="text-muted">Total Tasks</small>
                        </div>
                        <div class="col-4">
                            <span class="display-6 text-primary" th:text="${monthlyBadgeStats.monthsTracked()}">0</span>
                            <br><small class="text-muted">Meses</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Badge History -->
            <div th:if="${recentMonthlyBadges != null && !#lists.isEmpty(recentMonthlyBadges)}" class="mb-4">
                <h6 class="text-muted mb-2">Hist√≥rico de Selos</h6>
                <div class="d-flex flex-wrap gap-2">
                    <div th:each="badge : ${recentMonthlyBadges}" 
                         class="badge p-2" 
                         th:classappend="'badge-' + ${badge.level.name().toLowerCase()}"
                         th:title="${badge.referenceMonth + '/' + badge.referenceYear + ' - ' + badge.tasksCompletedInSquads + ' tasks'}"
                         data-bs-toggle="tooltip">
                        <span th:text="${badge.level.icon}">üèÜ</span>
                        <small th:text="${badge.referenceMonth + '/' + badge.referenceYear}">MM/YYYY</small>
                    </div>
                </div>
            </div>
            
            <hr class="my-4">
            <h5 class="mb-3">Badges Conquistados</h5>
            <div class="d-flex flex-wrap gap-2">
                <span th:each="userBadge : ${userBadges}" 
                      class="badge bg-gradient p-2 fs-6"
                      style="background: linear-gradient(45deg, #667eea, #764ba2);"
                      th:title="${userBadge.badge.description}"
                      data-bs-toggle="tooltip">
                    <i th:class="${userBadge.badge.iconClass} + ' me-1'"></i>
                    <span th:text="${userBadge.badge.name}">Badge</span>
                </span>
                <span th:if="${#lists.isEmpty(userBadges)}" class="text-muted">
                    Nenhum badge conquistado ainda. Complete tarefas em squads para ganhar!
                </span>
            </div>
        </div>

        <!-- Squads Section -->
        <div class="form-card profile-section-card" data-animate="fade-up" style="margin-top:1.5rem;">
            <h3 class="profile-section-title">
                <i class="bi bi-people-fill"></i> Minhas Squads
            </h3>
            <div th:if="${!#lists.isEmpty(mySquads)}" class="row">
                <div th:each="squadMember : ${mySquads}" class="col-md-6 mb-3">
                    <div class="card h-100 shadow-sm" th:classappend="${!squadMember.squad.active ? 'border-secondary opacity-75' : ''}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0" th:text="${squadMember.squad.name}">Nome da Squad</h5>
                                <span th:if="${squadMember.squad.lead.id == user.id}" 
                                      class="badge bg-warning text-dark">LEAD</span>
                            </div>
                            <p class="card-text text-muted small" th:text="${#strings.abbreviate(squadMember.squad.description, 80)}">Descri√ß√£o</p>
                            
                            <!-- Squad Type & Tech Stack -->
                            <div class="mb-2">
                                <span class="badge" 
                                      th:classappend="${squadMember.squad.type?.name() == 'BACKEND' ? 'bg-dark' : 
                                                       squadMember.squad.type?.name() == 'FRONTEND' ? 'bg-info' : 
                                                       squadMember.squad.type?.name() == 'DEVOPS' ? 'bg-warning text-dark' : 'bg-primary'}"
                                      th:text="${squadMember.squad.type?.displayName ?: 'Fullstack'}">Tipo</span>
                                <span class="badge" th:classappend="${squadMember.squad.active ? 'bg-success' : 'bg-secondary'}"
                                      th:text="${squadMember.squad.active ? 'Ativa' : 'Inativa'}">Status</span>
                            </div>
                            
                            <div th:if="${squadMember.squad.techStack}" class="small text-muted">
                                <i class="bi bi-code-slash"></i>
                                <span th:each="tech, iterStat : ${#strings.arraySplit(squadMember.squad.techStack, ',')}" 
                                      th:if="${iterStat.index < 3}">
                                    <span th:text="${#strings.trim(tech)}">Tech</span><span th:if="${iterStat.index < 2}">,</span>
                                </span>
                                <span th:if="${#strings.arraySplit(squadMember.squad.techStack, ',').length > 3}">...</span>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent">
                            <small class="text-muted">
                                <i class="bi bi-calendar3"></i> Membro desde 
                                <span th:text="${#temporals.format(squadMember.joinedAt, 'dd/MM/yyyy')}">Data</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            <p th:if="${#lists.isEmpty(mySquads)}" class="text-muted mb-0">
                Voc√™ ainda n√£o participa de nenhuma squad.
            </p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>

<link th:href="@{/css/gamification.css}" rel="stylesheet"/>

<script th:src="@{/js/sidebar.js}"></script>
<script th:src="@{/js/dashboard.js}"></script>

<!-- WebSocket Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<!-- Gamification Scripts -->
<script th:src="@{/js/squad-management.js}"></script>
<script th:src="@{/js/gamification-websocket.js}"></script>
<div th:replace="~{fragments/notifications :: notifications}"></div>
</body>
</html>
