<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('Tarefas - Task Management')}">
    <link rel="stylesheet" th:href="@{/css/task-list.css}" />
</head>
<body class="dashboard-body">
<!-- Sidebar -->
<nav th:replace="~{fragments/sidebar :: sidebar}"></nav>

<!-- Main Content -->
<div class="main-content" id="mainContent">
    <div class="top-bar fixed">
        <h1 class="page-title">Minhas Tarefas</h1>
        <div class="user-info" style="display: flex; gap: 1.5rem; align-items: center">
            <div th:replace="~{fragments/topbar-user-info :: userInfo}"></div>
            <a class="btn btn-primary" th:href="@{/tasks}">
                <i class="bi bi-plus-circle"></i> Nova Tarefa
            </a>
        </div>
    </div>

    <div class="content-wrapper">
        <div th:replace="~{fragments/alerts :: alerts}"></div>

        <!-- Filtros -->
        <div class="filter-card" data-animate="fade-up">
            <form method="get" th:action="@{/tasks}">
                <div class="filter-grid">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">
                            <i class="bi bi-funnel"></i> Status
                        </label>
                        <div class="select-wrapper">
                            <select class="form-control" name="status">
                                <option th:selected="${filter.status} == null" value="">Todos os status</option>
                                <option th:each="s : ${allStatuses}" th:selected="${filter.status} == ${s}"
                                        th:text="${s}" th:value="${s}"></option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">
                            <i class="bi bi-flag"></i> Prioridade
                        </label>
                        <div class="select-wrapper">
                            <select class="form-control" name="priority">
                                <option th:selected="${filter.priority} == null" value="">Todas as prioridades</option>
                                <option th:each="p : ${allPriorities}" th:selected="${filter.priority} == ${p}"
                                        th:text="${p}" th:value="${p}"></option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0; display: flex; align-items: flex-end; gap: 0.5rem;">
                        <button class="btn btn-primary" type="submit">
                            <i class="bi bi-search"></i> Filtrar
                        </button>
                        <a class="btn btn-secondary" th:href="@{/tasks}">
                            <i class="bi bi-x-circle"></i> Limpar
                        </a>
                    </div>
                </div>
            </form>
        </div>

        <!-- Tabela de Tarefas (Fragment Container) -->
        <div class="table-card" data-animate="fade-up" data-delay="100" id="taskTableContainer">
            <div id="taskTableInner" th:insert="~{fragments/task-table :: fragment}"></div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/task-modal :: fragment}"></div>

<!-- Extend Task Modal -->
<div aria-hidden="true" aria-labelledby="extendTaskModalLabel" class="modal fade" id="extendTaskModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header modal-header-warning">
                <h5 class="modal-title" id="extendTaskModalLabel">
                    <i class="bi bi-clock-history"></i>
                    Estender Tempo da Tarefa
                </h5>
                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <input id="extendTaskId" type="hidden">
                <div class="mb-3">
                    <h6 class="text-muted">
                        <i class="bi bi-file-earmark-text"></i>
                        <span id="extendTaskTitle">Título da Tarefa</span>
                    </h6>
                </div>

                <div class="mb-3">
                    <label class="form-label" for="extendExtraTime">
                        <i class="bi bi-clock"></i>
                        Tempo Extra (minutos) <span class="text-danger">*</span>
                    </label>
                    <input class="form-control" id="extendExtraTime" min="1" placeholder="Ex: 30" required
                           type="number">
                    <small class="form-text text-muted">Informe quantos minutos deseja adicionar à estimativa</small>
                </div>

                <div class="mb-3">
                    <label class="form-label" for="extendScheduledStart">
                        <i class="bi bi-calendar-event"></i>
                        Nova Data de Início
                    </label>
                    <input class="form-control" id="extendScheduledStart" type="datetime-local">
                </div>

                <div class="mb-3">
                    <label class="form-label" for="extendDueDate">
                        <i class="bi bi-calendar-check"></i>
                        Nova Data de Vencimento
                    </label>
                    <input class="form-control" id="extendDueDate" type="datetime-local">
                </div>

                <div class="mb-3">
                    <label class="form-label" for="extendJustification">
                        <i class="bi bi-journal-text"></i>
                        Justificativa/Observação
                    </label>
                    <textarea class="form-control" id="extendJustification"
                              placeholder="Descreva o motivo da extensão de tempo..."
                              rows="4"></textarea>
                    <small class="form-text text-muted">Importante para rastreamento e histórico da tarefa</small>
                </div>

                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Atenção:</strong> Ao estender a tarefa, o tempo extra será somado ao tempo de execução
                    original
                    e a tarefa voltará ao estado TODO para ser reiniciada.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">
                    <i class="bi bi-x-circle"></i>
                    Fechar
                </button>
                <button class="btn btn-warning" id="extendSubmitBtn" onclick="submitExtendTask()" type="button">
                    <i class="bi bi-clock-history"></i>
                    Estender Tarefa
                </button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>

<script th:src="@{/js/sidebar.js}"></script>
<script th:src="@{/js/dashboard.js}"></script>
<script th:src="@{/js/task-list.js}"></script>
<div th:replace="~{fragments/notifications :: notifications}"></div>
</body>
</html>
